<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>Privileged JAR Load Test</title>
		<meta name="author" content="Eric Naeseth (Carleton College)" />
		<script type="text/javascript" charset="utf-8">
			parent.GeckoClipboard = {
				get: function gecko_get_clipboard()
				{
					// Adapted from <http://www.mozilla.org/xpfe/xptoolkit/clipboard.html>, 
					// with help from <http://www.xulplanet.com/tutorials/xultu/clipboard.html>.

					// This will cause a dialog asking the user to
					// allow clipboard operations (unless the user's already
					// said yes or no permanently).
					var priv = 'UniversalXPConnect';
					try {
						netscape.security.PrivilegeManager.enablePrivilege(priv);	
					} catch (e) {
						// Permission denied.
						alert('Your permission is needed to access the clipboard. I will ' +
							'try again to get it; please accept if you would like to cut,' +
							' copy, or paste.');

						netscape.security.PrivilegeManager.enablePrivilege(priv);
					}

					// 1. get the clipboard service
					var clipid = Components.interfaces.nsIClipboard;
					var clipboard = Components.classes["@mozilla.org/widget/clipboard;1"].getService(clipid);

					// 2. create the transferable
					// Make transferable.
					var trans = Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);
					if (!trans) return false;

					if ( trans && clipboard )
					{
						// 3. register the data flavors you want, highest fidelity first
						trans.addDataFlavor("text/html");
						trans.addDataFlavor("text/unicode");

						// 4. get transferable from clipboard
						clipboard.getData(trans, clipboard.kGlobalClipboard);

						// 5. ask transferable for the best flavor. Need to create new JS
						//    objects for the out params.
						var dataObj = new Object();
						var bestFlavor = new Object();
						var len = new Object();
						trans.getAnyTransferData ( bestFlavor, dataObj, len );
						if ( bestFlavor.value == "text/html" ||
							 bestFlavor.value == "text/unicode" )
						{
							if ( dataObj )
							  dataObj = dataObj.value.QueryInterface(Components.interfaces.nsISupportsString);
							if ( dataObj )
							  // ...do something with the data. remember len is in bytes, not chars
							  var pasteable = dataObj.data.substring(0, len.value / 2);
						}
					}

					return (bestFlavor.value)
						? {type: bestFlavor.value, value: pasteable || null}
						: null;
				},
				
				set: function gecko_set_clipboard(html)
				{
					// Adapted from <http://www.experts-exchange.com/Web/Web_Languages/JavaScript/Q_20233392.html>, which is adapted from <http://www.krikkit.net/howto_javascript_copy_clipboard.html>, which is probably adapted from somewhere on mozilla.org. See also <http://www.xulplanet.com/tutorials/xultu/clipboard.html>

					var copyText = html;

					// This will cause a dialog asking the user to
					// allow clipboard operations (unless the user's already
					// said yes or no permanently).
					var priv = 'UniversalXPConnect';
					try {
						netscape.security.PrivilegeManager.enablePrivilege(priv);	
					} catch (e) {
						// Permission denied.
						alert('Your permission is needed to access the clipboard. I will ' +
							'try again to get it; please accept if you would like to cut,' +
							' copy, or paste.');

						netscape.security.PrivilegeManager.enablePrivilege(priv);
					}

					// Store support string in an object.
					var str = Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);
					if (!str) return false;
					str.data = copyText;

					// Make transferable.
					var trans = Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);
					if (!trans) return false;

					// Specify what datatypes we want to obtain, which is text in this case.
					trans.addDataFlavor("text/html");
					trans.setTransferData("text/html", str, copyText.length * 2);
					// XXX: uncommented following two lines, 2006-02-12
					trans.addDataFlavor("text/unicode");
					trans.setTransferData("text/unicode", str, copyText.length * 2);

					var clipid = Components.interfaces.nsIClipboard;
					var clip = Components.classes["@mozilla.org/widget/clipboard;1"].getService(clipid);
					if (!clip) return false;

					clip.setData(trans, null, clipid.kGlobalClipboard);
				}
			};
		</script>
	</head>
	<body id="privileged">
	</body>
</html>