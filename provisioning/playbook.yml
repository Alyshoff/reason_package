---
- hosts: all
  vars:
    http_port: 80
    max_clients: 200
  user: vagrant
  sudo: yes
  tasks:
  - name: ensure apache & php are installed
    apt: pkg={{ item }} state=present update_cache=yes
    with_items:
      - apache2
      - php5
      - libapache2-mod-php5
      - php5-mysql
      - php5-tidy
      - php5-curl
      - imagemagick
    notify:
    - restart apache
  - name: ensure apache is running
    service: name=apache2 state=started
  - name: ensure MySQL is installed
    apt: pkg={{ item }} state=present
    with_items:
      - mysql-server
      - python-mysqldb
  - name: Start the MySQL service
    service: name=mysql state=started
  - name: create db 'reason'
    mysql_db: db=reason state=present
  # WARNING!: usernames and passwords should not be specified here for production!
  - name: create user reason_user...NO PRODUCTION PASSWORDS
    mysql_user: state=present name=reason_user password=some_password priv=reason.*:ALL

  - name: create reason symlinks
    file: src={{ item.src }} dest={{ item.dest }} owner=www-data group=www-data state=link
    with_items:
      - { src: '/var/reason/reason_4.0/www/', dest: '/var/www/reason' }
      - { src: '/var/reason/www/', dest: '/var/www/reason_package' }
      - { src: '/var/reason/thor/', dest: '/var/www/thor' }
      - { src: '/var/reason/reason_package/loki_2.0/', dest: '/var/www/loki_2.0' }
      - { src: '/var/reason/reason_package/flvplayer/', dest: '/var/www/flvplayer' }
      - { src: '/var/reason/reason_package/jquery/', dest: '/var/wwww/jquery' }
      - { src: '/var/reason/reason_package/date_picker/', dest: '/var/www/date_picker' }

  - name: set permissions on write required dirs
    file: path={{ item }} group=www-data mode=0774
    with_items:
      - /var/www/
      - /var/reason/reason_4.0/data/csv_data/
      - /var/reason/reason_4.0/data/logs/
      - /var/reason/reason_4.0/data/assets/
      - /var/reason/reason_4.0/data/images/
      - /var/reason/reason_4.0/data/tmp/
      - /var/reason/reason_4.0/data/cache/
      - /var/www/reason/tmp/
      - /var/reason/reason_4.0/data/geocodes/
  - name: copy php.ini to /etc/php5/apache2/php.ini
    copy: src=php.ini dest=/etc/php5/apache2/php.ini owner=root group=root mode=0644
    notify:
    - restart apache
  - name: copy reason config files for vagrant
    copy: src={{ item }} dest=/vagrant/settings/{{ item }}
    with_items:
      - dbs.xml
      - error_handler_settings.php
  - name: copy apache config with rewrite FileInfo
    copy: src=default dest=/etc/apache2/sites-available/default owner=root group=root mode=0644
    notify:
    - restart apache
  - name: Apache enable rewrite
    command: a2enmod rewrite creates=/etc/apache2/mods-enabled/rewrite.load
    notify: 
    - restart apache
  - name: Write initial database data
    command: sh /vagrant/provisioning/init_dbs.sh creates=/home/vagrant/dbs_written
  handlers:
    - name: restart apache
      service: name=apache2 state=restarted
